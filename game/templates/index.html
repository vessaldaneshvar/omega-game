{% load static %}

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>بازی</title>
    <link rel="stylesheet" href={% static "assets/bootstrap/css/bootstrap.min.css" %}>
    <link rel="stylesheet" href={% static "assets/fonts/font-awesome.min.css" %}>

    <style>
        body {
            background-color: #f0eded;
        }
    </style>
</head>

<body class="text-secondary" style="width: 100%;height: 100%;">
    <div class="text-center"><i class="fa fa-gamepad" style="font-size: 80px;"></i>
        <div style="margin: 5%;width: 90%;height: 95%;filter: blur(0px);"><strong style="color: rgb(17,143,255);">ساخت
                گروه</strong>
            <div style="padding: 1%;">
                <form method="GET" action="#" onsubmit="return false;">
                    <div style="padding-bottom: 2%;"><label for="group-name">اسم گروه :</label>
                        <input class="form-control" type="text" style="margin: 0;" name="group-name" id="group-name"
                            placeholder="اسم گروه"></div>
                    <div style="padding-bottom: 4%;">
                        <label for="game-id">انتخاب بازی : </label>
                        <select class="form-control" name="game-select" id="game-id">
                            <optgroup label="انتخاب بازی">
                                {% for game in games %}
                                <option value="{{game.name}}">{{game.name}}</option>
                                {% empty %}
                                <option value="no-game">No Game</option>
                                {% endfor %}
                            </optgroup>
                        </select></div>
                    <div><button class="btn btn-primary" type="button" onclick="creategroup();">ایجاد گروه</button>
                    </div>
                </form>
            </div>
        </div>
        <div id='div_join_group'><strong style="color: rgb(235,14,0);">عضو شدن در گروه ها&nbsp;</strong>
            {% for group in groups %}
            <div class="row">
                <div class="col">
                    <div class="card" style="margin: 6%;">
                        <div class="card-body rounded" style="background-color: #ffbe76;">
                            <h4 class="card-title" style="color: rgb(251,251,251);">اسم گروه : {{group.group_name}}</h4>
                            <h6 class="text-muted card-subtitle mb-2">نام بازی : {{group.game}}</h6>
                            <h6 class="text-muted card-subtitle mb-2">ظرفیت باقی مانده : 1 عدد</h6>
                            <button class="btn btn-primary" type="button"
                                onclick="joingroup_button('{{group.group_name}}');">عضو شدن در گروه</button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            No Group
            {% endfor %}

            <div class="spinner-border text-primary" id="spinner" role="status">
                <span class="sr-only">Loading...</span>
            </div>



        </div>
    </div>
    <script src={% static "assets/js/jquery.min.js" %}></script>
    <script src={% static "assets/bootstrap/js/bootstrap.min.js" %}></script>
    <script>
        groups_socket = new WebSocket(
            "ws://" + window.location.host + "/game/groups/"
        )
        groups_socket.onmessage = function (e) {
            console.log(e)
            data_group = JSON.parse(e.data)
            if (data_group["message_type"] == "broadcast_newgroup") {
                create_card_join(data_group)
            }
            else if (data_group["message_type"] == "ready_groups"){
                console.log(data_group)
                start_game(data_group["slug"])
            }
        }

        function joingroup_button(group_name) {
            console.log(group_name)
            join_group_items = document.getElementById('div_join_group').getElementsByTagName("Button")
            for (let index = 0; index < join_group_items.length; index++) {
                join_group_items[index].disabled = true;

            }
            join_group_data = {
                "message_type" : "join_group",
                "group_name" : group_name,

            }
            groups_socket.send(JSON.stringify(join_group_data))
        }

        function create_card_join(group_game_data) {
            card_element = document.createElement("DIV")
            card_element.className = "row"
            card_element.innerHTML = `<div class="col">
                    <div class="card" style="margin: 6%;">
                        <div class="card-body rounded" style="background-color: #e74c3c;">
                            <h4 class="card-title" style="color: rgb(251,251,251);">اسم گروه : ${group_game_data['group_name']}</h4>
                            <h6 class="text-muted card-subtitle mb-2">نام بازی : ${group_game_data['game_name']}</h6>
                            <h6 class="text-muted card-subtitle mb-2">ظرفیت باقی مانده : 1 عدد</h6>
                            <button class="btn btn-primary" type="button" onclick="joingroup_button('${group_game_data['group_name']}');">عضو شدن در گروه</button>
                        </div>
                    </div>
                </div>`
            join_section_element = document.getElementById("div_join_group")
            first_element_join_section = join_section_element.getElementsByTagName('div')[0]
            join_section_element.insertBefore(card_element, first_element_join_section)

        }
        function creategroup() {
            group_name = document.getElementById("group-name").value
            game_object = document.getElementById('game-id')
            game_name = game_object[game_object.selectedIndex].text
            
            start_game_data = {
                "message_type" : "create_group",
                "group_name" : group_name,
                "game_name": game_name,
            }
            groups_socket.send(JSON.stringify(start_game_data))
        }
        function start_game(slug) {
            window.open(slug,"_self")
        }
    </script>
</body>

</html>